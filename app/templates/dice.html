{% extends "base.html" %}

{% block content %}
<div class="game-container dice-game">
    <!-- Premium Game Header -->
    <div class="game-header">
        <div class="header-left">
            <a href="/" class="back-link">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7" />
                </svg>
                BACK
            </a>
        </div>
        <div class="header-center">
            <h2><span class="pulse-icon">üé≤</span> DICE ROLL</h2>
        </div>
        <div class="header-right">
            <div class="balance-pill">
                <span class="label">CREDITS</span>
                <span class="value" id="game-balance">---</span>
            </div>
        </div>
    </div>

    <!-- Dice Display Area -->
    <div class="game-area">
        <div class="dice-container">
            <div class="die" id="die-1">
                <div class="dot center"></div>
            </div>
            <div class="die" id="die-2">
                <div class="dot center"></div>
            </div>
        </div>
        <div class="roll-total" id="roll-total">Total: 2</div>
        <div id="result-message" class="result-message"></div>
    </div>

    <!-- Bet Controls -->
    <div class="game-controls">
        <div class="control-row">
            <div class="bet-input-group">
                <label>BET AMOUNT</label>
                <div class="bet-input-wrapper">
                    <button class="bet-adjust" onclick="adjustBet(-5); playSound('click');">-</button>
                    <input type="number" id="bet-amount" value="{{ min_bet }}" min="{{ min_bet }}" max="{{ max_bet }}">
                    <button class="bet-adjust" onclick="adjustBet(5); playSound('click');">+</button>
                </div>
                <div class="bet-quick-actions">
                    <button class="quick-bet-btn" onclick="setBet({{ min_bet }})">MIN</button>
                    <button class="quick-bet-btn" onclick="setBet({{ max_bet }})">MAX</button>
                </div>
            </div>

            <div class="bet-input-group">
                <label>PREDICTION (2-12)</label>
                <div class="bet-input-wrapper">
                    <button class="bet-adjust" onclick="adjustPrediction(-1); playSound('click');">-</button>
                    <input type="number" id="bet-value" value="7" min="2" max="12">
                    <button class="bet-adjust" onclick="adjustPrediction(1); playSound('click');">+</button>
                </div>
            </div>
        </div>

        <button class="action-btn roll-btn" id="roll-btn" onclick="rollDice()">
            <span class="btn-icon">üé≤</span> ROLL DICE
        </button>
    </div>

    <style>
        /* Dice Specifics */
        .dice-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 40px 0;
            perspective: 600px;
        }

        .die {
            width: 80px;
            height: 80px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            display: grid;
            grid-template: repeat(3, 1fr) / repeat(3, 1fr);
            padding: 8px;
            transition: transform 0.5s ease-out;
            position: relative;
        }

        .die .dot {
            background-color: #333;
            border-radius: 50%;
            width: 14px;
            height: 14px;
            margin: auto;
            box-shadow: inset 0 2px 2px rgba(0, 0, 0, 0.5);
        }

        /* Dot positioning helper classes */
        .die .dot:nth-child(1) {
            grid-area: 1 / 1;
        }

        .die .dot:nth-child(2) {
            grid-area: 1 / 3;
        }

        .die .dot:nth-child(3) {
            grid-area: 2 / 2;
        }

        .die .dot:nth-child(4) {
            grid-area: 3 / 1;
        }

        .die .dot:nth-child(5) {
            grid-area: 3 / 3;
        }

        .die .dot:nth-child(6) {
            grid-area: 2 / 1;
        }

        .die .dot:nth-child(7) {
            grid-area: 2 / 3;
        }

        .roll-total {
            font-size: 2rem;
            font-weight: 800;
            color: var(--text-main);
            margin-bottom: 20px;
        }

        .result-message {
            height: 30px;
            font-size: 1.2rem;
            font-weight: bold;
        }

        .control-row {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .roll-btn {
            background: linear-gradient(135deg, #FF9800, #F57C00);
            width: 100%;
            max-width: 300px;
        }

        .roll-btn:hover {
            box-shadow: 0 0 20px rgba(255, 152, 0, 0.4);
        }

        /* Dot Patterns */
        /* 1 */
        .die[data-face="1"] .dot:not(:nth-child(1)) {
            display: none;
        }

        .die[data-face="1"] .dot:nth-child(1) {
            grid-area: 2 / 2;
        }

        /* 2 */
        .die[data-face="2"] .dot:nth-child(n+3) {
            display: none;
        }

        .die[data-face="2"] .dot:nth-child(1) {
            grid-area: 1 / 1;
        }

        .die[data-face="2"] .dot:nth-child(2) {
            grid-area: 3 / 3;
        }

        /* 3 */
        .die[data-face="3"] .dot:nth-child(n+4) {
            display: none;
        }

        .die[data-face="3"] .dot:nth-child(1) {
            grid-area: 1 / 1;
        }

        .die[data-face="3"] .dot:nth-child(2) {
            grid-area: 2 / 2;
        }

        .die[data-face="3"] .dot:nth-child(3) {
            grid-area: 3 / 3;
        }

        /* 4 */
        .die[data-face="4"] .dot:nth-child(n+5) {
            display: none;
        }

        .die[data-face="4"] .dot:nth-child(1) {
            grid-area: 1 / 1;
        }

        .die[data-face="4"] .dot:nth-child(2) {
            grid-area: 1 / 3;
        }

        .die[data-face="4"] .dot:nth-child(3) {
            grid-area: 3 / 1;
        }

        .die[data-face="4"] .dot:nth-child(4) {
            grid-area: 3 / 3;
        }

        /* 5 */
        .die[data-face="5"] .dot:nth-child(n+6) {
            display: none;
        }

        .die[data-face="5"] .dot:nth-child(1) {
            grid-area: 1 / 1;
        }

        .die[data-face="5"] .dot:nth-child(2) {
            grid-area: 1 / 3;
        }

        .die[data-face="5"] .dot:nth-child(3) {
            grid-area: 2 / 2;
        }

        .die[data-face="5"] .dot:nth-child(4) {
            grid-area: 3 / 1;
        }

        .die[data-face="5"] .dot:nth-child(5) {
            grid-area: 3 / 3;
        }

        /* 6 */
        .die[data-face="6"] .dot:nth-child(n+7) {
            display: none;
        }

        .die[data-face="6"] .dot:nth-child(1) {
            grid-area: 1 / 1;
        }

        .die[data-face="6"] .dot:nth-child(2) {
            grid-area: 1 / 3;
        }

        .die[data-face="6"] .dot:nth-child(3) {
            grid-area: 2 / 1;
        }

        .die[data-face="6"] .dot:nth-child(4) {
            grid-area: 2 / 3;
        }

        .die[data-face="6"] .dot:nth-child(5) {
            grid-area: 3 / 1;
        }

        .die[data-face="6"] .dot:nth-child(6) {
            grid-area: 3 / 3;
        }

        /* Quick Actions & Balance Pill (Copied from Slots) */
        .bet-input-wrapper {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .bet-quick-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .quick-bet-btn {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            color: var(--text-dim);
            border-radius: 4px;
            padding: 2px 8px;
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-bet-btn:hover {
            background: var(--primary);
            color: #000;
        }

        .balance-pill {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            min-width: 100px;
        }

        .balance-pill .label {
            font-size: 0.65rem;
            color: var(--text-dim);
            font-weight: 700;
            letter-spacing: 1px;
        }

        .balance-pill .value {
            font-size: 1.1rem;
            color: var(--primary);
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            line-height: 1;
        }
    </style>
</div>
{% endblock %}

{% block scripts %}
<script>
    let isRolling = false;

    // Init balance display
    document.addEventListener('DOMContentLoaded', () => {
        const globalBal = document.getElementById('credits-balance');
        const gameBal = document.getElementById('game-balance');
        if (globalBal && gameBal) {
            gameBal.textContent = globalBal.textContent;
            const observer = new MutationObserver(() => { gameBal.textContent = globalBal.textContent; });
            observer.observe(globalBal, { childList: true, characterData: true, subtree: true });
        }

        // Render initial dice (snake eyes)
        renderDie(document.getElementById('die-1'), 1);
        renderDie(document.getElementById('die-2'), 1);
    });

    function adjustBet(amount) {
        const input = document.getElementById('bet-amount');
        let val = parseInt(input.value || 0) + amount;
        setBet(val);
    }

    function setBet(amount) {
        const input = document.getElementById('bet-amount');
        const min = {{ min_bet }};
    const max = {{ max_bet }};
    input.value = Math.max(min, Math.min(max, amount));
    }

    function adjustPrediction(amount) {
        const input = document.getElementById('bet-value');
        let val = parseInt(input.value) + amount;
        if (val < 2) val = 2;
        if (val > 12) val = 12;
        input.value = val;
    }

    function renderDie(dieElement, value) {
        dieElement.setAttribute('data-face', value);
        dieElement.innerHTML = '';
        // Create 9 dots for valid grid placement
        for (let i = 0; i < 9; i++) {
            const dot = document.createElement('div');
            dot.className = 'dot';
            dieElement.appendChild(dot);
        }
    }

    async function rollDice() {
        if (isRolling) return;

        const bet = parseFloat(document.getElementById('bet-amount').value);
        const prediction = parseInt(document.getElementById('bet-value').value);
        const rollBtn = document.getElementById('roll-btn');
        const resultEl = document.getElementById('result-message');

        isRolling = true;
        rollBtn.disabled = true;
        rollBtn.textContent = 'üé≤ ROLLING...';
        resultEl.textContent = '';

        // Animation
        const dice = document.querySelectorAll('.die');
        dice.forEach(die => {
            die.style.transform = `rotateX(${Math.random() * 720}deg) rotateY(${Math.random() * 720}deg)`;
        });
        playSound('diceShake');

        try {
            const response = await fetch('/api/games/dice/roll', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    bet: bet,
                    bet_type: 'exact',
                    bet_value: prediction.toString()
                })
            });

            const data = await response.json();

            if (!response.ok) {
                let msg = data.detail || 'Roll failed';
                if (Array.isArray(msg)) msg = msg.map(e => e.msg).join(', ');
                else if (typeof msg === 'object') msg = JSON.stringify(msg);
                throw new Error(msg);
            }

            // Wait for anim
            await new Promise(r => setTimeout(r, 800));

            // Set final state
            dice.forEach(die => die.style.transform = 'none');
            renderDie(document.getElementById('die-1'), data.dice[0]);
            renderDie(document.getElementById('die-2'), data.dice[1]);
            document.getElementById('roll-total').textContent = `Total: ${data.total}`;
            playSound('diceLand');

            if (data.win) {
                resultEl.textContent = `üéâ YOU WON! +${data.payout} CR`;
                resultEl.style.color = '#4CAF50';
                playSound('win');
            } else {
                resultEl.textContent = '‚ùå Try again!';
                resultEl.style.color = '#f44336';
                playSound('lose');
            }

            updateBalance(data.balance);

        } catch (error) {
            resultEl.textContent = 'Error: ' + error.message;
            resultEl.style.color = '#f44336';
            playSound('error');
        }

        isRolling = false;
        rollBtn.disabled = false;
        rollBtn.textContent = 'üé≤ ROLL DICE';
    }
</script>
{% endblock %}