{% extends "base.html" %}

{% block content %}
<div class="game-container lottery-container">
    <!-- Premium Game Header -->
    <div class="game-header">
        <div class="header-left">
            <a href="/" class="back-link">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7" />
                </svg>
                BACK
            </a>
        </div>
        <div class="header-center">
            <h2><span class="pulse-icon">üé±</span> LOTTERY</h2>
        </div>
        <div class="header-right">
            <div class="balance-pill">
                <span class="label">CREDITS</span>
                <span class="value" id="game-balance">---</span>
            </div>
        </div>
    </div>

    <!-- Jackpot Hero Section -->
    <div class="lottery-hero">
        <div class="jackpot-card">
            <div class="jackpot-label">CURRENT JACKPOT</div>
            <div class="jackpot-value">$<span id="jackpot-amount">---</span></div>
            <div class="draw-info">
                <div class="countdown-pill">
                    <span class="icon">‚è≥</span>
                    <span id="countdown-timer">Loading...</span>
                </div>
                <div class="next-draw-date">
                    Next Draw: <span id="next-draw-time">---</span>
                </div>
            </div>
        </div>

        <div class="lottery-stats">
            <div class="stat-item">
                <span class="stat-icon">üé´</span>
                <div class="stat-text">
                    <span class="label">Ticket Price</span>
                    <span class="value">$<span id="ticket-price">50</span></span>
                </div>
            </div>
            <div class="stat-item">
                <span class="stat-icon">üéØ</span>
                <div class="stat-text">
                    <span class="label">Pick From</span>
                    <span class="value">1-49</span>
                </div>
            </div>
            <div class="stat-item">
                <span class="stat-icon">üìÖ</span>
                <div class="stat-text">
                    <span class="label">Draw Schedule</span>
                    <span class="value">Monthly (1st Fri)</span>
                </div>
            </div>
        </div>
    </div>

    {% if gamble_friday_active %}
    <div class="alert-banner warning">
        <span class="icon">‚ö†Ô∏è</span>
        <span>Note: Lottery is excluded from Gamble Friday bonuses.</span>
    </div>
    {% endif %}

    <!-- Ticket Purchase Section -->
    <!-- Ticket Purchase Section -->
    <div class="glass-panel ticket-panel">
        <div class="panel-header">
            <h3>üé´ Purchase Ticket</h3>
        </div>

        <div class="selection-area">
            <div class="number-grid-wrapper">
                <div class="number-grid" id="number-grid">
                    <!-- Numbers 1-49 generated by JS -->
                </div>
            </div>

            <div class="ticket-sidebar">
                <div class="selected-numbers-card">
                    <label>YOUR SELECTION</label>
                    <div class="selected-numbers" id="selected-numbers">
                        <span class="placeholder">Select 6 numbers</span>
                    </div>
                </div>

                <div class="ticket-actions">
                    <div class="action-row">
                        <button class="action-btn secondary small" onclick="clearSelection()">CLEAR</button>
                        <button class="action-btn secondary small" onclick="quickPick()">üé≤ RANDOM</button>
                    </div>
                    <button class="action-btn buy-btn" id="buy-btn" onclick="buyTicket()" disabled>
                        <span>BUY TICKET</span>
                        <span class="price-tag">$<span id="buy-price">50</span></span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Prize Tiers -->
    <div class="prize-tiers-section">
        <h3>üèÜ Prize Tiers</h3>
        <div class="tiers-grid">
            <div class="tier jackpot-tier">
                <div class="tier-match">6 Matches</div>
                <div class="tier-prize">üéâ JACKPOT</div>
            </div>
            <div class="tier">
                <div class="tier-match">5 Matches</div>
                <div class="tier-prize">$5,000</div>
            </div>
            <div class="tier">
                <div class="tier-match">4 Matches</div>
                <div class="tier-prize">$500</div>
            </div>
            <div class="tier">
                <div class="tier-match">3 Matches</div>
                <div class="tier-prize">$25</div>
            </div>
            <div class="tier">
                <div class="tier-match">2 Matches</div>
                <div class="tier-prize">Free Ticket</div>
            </div>
        </div>
    </div>

    <!-- User Tickets -->
    <div class="my-tickets-section">
        <h3>üéüÔ∏è My Tickets (Current Draw)</h3>
        <div class="tickets-container" id="my-tickets">
            <div class="no-tickets">No tickets yet. Purchase one above!</div>
        </div>
    </div>

    <!-- Draw History -->
    <div class="history-section">
        <h3>üìú Recent Draws</h3>
        <div class="history-container">
            <table class="history-table">
                <thead>
                    <tr>
                        <th>Draw</th>
                        <th>Winning Numbers</th>
                        <th>Jackpot</th>
                        <th>Winners</th>
                    </tr>
                </thead>
                <tbody id="history-body">
                    <tr>
                        <td colspan="4" class="loading">Loading history...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Coinflip Modal for Multiple Winners -->
<div id="coinflip-modal" class="modal" style="display: none;">
    <div class="modal-overlay" onclick="closeCoinflipModal()"></div>
    <div class="modal-content">
        <h2>üéâ Multiple Jackpot Winners!</h2>
        <p>Congratulations! You and another player both won the jackpot!</p>
        <p>You have two options:</p>
        <ul>
            <li><strong>Coin Flip:</strong> If both agree, the winner takes ALL!</li>
            <li><strong>Split:</strong> The jackpot is split 50/50 between winners.</li>
        </ul>
        <p class="warning">‚ö†Ô∏è You have 24 hours to respond.</p>
        <div class="modal-actions">
            <button class="btn primary" onclick="respondCoinFlip(true)">
                üé≤ Agree to Coin Flip
            </button>
            <button class="btn secondary" onclick="respondCoinFlip(false)">
                üí∞ Decline (Split 50/50)
            </button>
        </div>
        <div class="modal-status" id="coinflip-status"></div>
    </div>
</div>

<!-- Result Toast -->
<div id="lottery-toast" class="lottery-toast"></div>

<!-- Admin Controls -->
{% if user and user.is_admin %}
<div class="admin-section">
    <h3>üõ†Ô∏è Admin Tools</h3>
    <p class="admin-warning">‚ö†Ô∏è Actions here affect the live game.</p>
    <div class="admin-controls">
        <button class="btn primary btn-danger" onclick="triggerDraw()">üö® FORCE DRAW NOW</button>
    </div>
    <div id="admin-status" class="admin-status"></div>
</div>

<style>
    .admin-section {
        background: rgba(255, 0, 0, 0.1);
        border: 1px solid #ff4444;
        border-radius: 12px;
        padding: 1.5rem;
        margin-top: 2rem;
        text-align: center;
    }

    .admin-warning {
        color: #ff8888;
        margin-bottom: 1rem;
    }

    .btn-danger {
        background: #ff4444 !important;
        color: white !important;
    }

    .btn-danger:hover {
        background: #cc0000 !important;
    }
</style>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
    // ... existing vars ...

    {% if user and user.is_admin %}
    async function triggerDraw() {
        if (!confirm('Are you sure you want to trigger the lottery draw manually? This will pick winners and reset the tickets.')) return;

        const btn = document.querySelector('.btn-danger');
        btn.disabled = true;
        btn.textContent = 'Processing Draw...';

        try {
            const response = await fetch('/api/games/lottery/draw-admin', {
                method: 'POST'
            });
            const result = await response.json();

            if (response.ok && result.success) {
                showToast(result.message, 'success');
                // Refresh all data
                await loadLotteryInfo();
                await loadMyTickets();
                await loadHistory();
            } else {
                showToast('Draw failed: ' + (result.detail || 'Unknown error'), 'error');
            }
        } catch (e) {
            showToast('Network error triggering draw', 'error');
        }

        btn.disabled = false;
        btn.textContent = 'üö® FORCE DRAW NOW';
    }
    {% endif %}

    let selectedNumbers = [];
    let lotteryInfo = null;
    let coinflipRequestId = null;
    const MAX_NUMBERS = 6;
    const NUMBER_RANGE = 49;

    // Initialize on load
    document.addEventListener('DOMContentLoaded', async () => {
        // Init balance sync
        const globalBal = document.getElementById('credits-balance');
        const gameBal = document.getElementById('game-balance');
        if (globalBal && gameBal) {
            gameBal.textContent = globalBal.textContent;
            const observer = new MutationObserver(() => { gameBal.textContent = globalBal.textContent; });
            observer.observe(globalBal, { childList: true, characterData: true, subtree: true });
        }

        generateNumberGrid();
        await loadLotteryInfo();
        await loadMyTickets();
        await loadHistory();
        await checkCoinflipStatus();

        // Refresh data periodically
        setInterval(loadLotteryInfo, 60000); // Every minute
        setInterval(checkCoinflipStatus, 30000); // Every 30 seconds
    });

    function generateNumberGrid() {
        const grid = document.getElementById('number-grid');
        grid.innerHTML = '';

        for (let i = 1; i <= NUMBER_RANGE; i++) {
            const num = document.createElement('div');
            num.className = 'lottery-number';
            num.textContent = i;
            num.dataset.number = i;
            num.onclick = () => toggleNumber(i);
            grid.appendChild(num);
        }
    }

    function toggleNumber(num) {
        const idx = selectedNumbers.indexOf(num);

        if (idx > -1) {
            selectedNumbers.splice(idx, 1);
        } else if (selectedNumbers.length < MAX_NUMBERS) {
            selectedNumbers.push(num);
        } else {
            showToast('You can only select 6 numbers', 'error');
            return;
        }

        updateSelectionDisplay();
    }

    function updateSelectionDisplay() {
        // Update grid visual
        document.querySelectorAll('.lottery-number').forEach(el => {
            const num = parseInt(el.dataset.number);
            el.classList.toggle('selected', selectedNumbers.includes(num));
        });

        // Update selected numbers display
        const display = document.getElementById('selected-numbers');
        if (selectedNumbers.length === 0) {
            display.innerHTML = '<span class="placeholder">Select 6 numbers</span>';
        } else {
            const sorted = [...selectedNumbers].sort((a, b) => a - b);
            display.innerHTML = sorted.map(n => `<span class="selected-num">${n}</span>`).join('');
        }

        // Update buy button
        const buyBtn = document.getElementById('buy-btn');
        buyBtn.disabled = selectedNumbers.length !== MAX_NUMBERS;
    }

    function clearSelection() {
        selectedNumbers = [];
        updateSelectionDisplay();
    }

    function quickPick() {
        selectedNumbers = [];
        const available = Array.from({ length: NUMBER_RANGE }, (_, i) => i + 1);

        for (let i = 0; i < MAX_NUMBERS; i++) {
            const idx = Math.floor(Math.random() * available.length);
            selectedNumbers.push(available.splice(idx, 1)[0]);
        }

        updateSelectionDisplay();
        showToast('Quick pick generated!', 'success');
    }

    async function buyTicket() {
        if (selectedNumbers.length !== MAX_NUMBERS) {
            showToast('Please select exactly 6 numbers', 'error');
            return;
        }

        const buyBtn = document.getElementById('buy-btn');
        buyBtn.disabled = true;
        buyBtn.textContent = 'Purchasing...';

        try {
            const response = await fetch('/api/games/lottery/buy', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ numbers: selectedNumbers })
            });

            const result = await response.json();

            if (response.ok && result.success) {
                showToast(`Ticket #${result.ticket_id} purchased! Numbers: ${result.numbers.join(', ')}`, 'success');
                clearSelection();
                await loadMyTickets();
                await loadLotteryInfo(); // Refresh jackpot

                // Refresh balance display
                const balResp = await fetch('/api/economy/balance');
                const bal = await balResp.json();
                if (!bal.is_admin) {
                    document.getElementById('cash-balance').textContent = bal.cash.toFixed(2);
                }
            } else {
                showToast(result.detail || result.error || 'Purchase failed', 'error');
            }
        } catch (e) {
            showToast('Network error', 'error');
        }

        buyBtn.disabled = false;
        buyBtn.innerHTML = `Buy Ticket ($<span id="buy-price">${lotteryInfo?.ticket_price || 50}</span>)`;
    }

    async function loadLotteryInfo() {
        try {
            const response = await fetch('/api/games/lottery/info');
            lotteryInfo = await response.json();

            // Update display
            document.getElementById('jackpot-amount').textContent = formatCurrency(lotteryInfo.jackpot);
            document.getElementById('ticket-price').textContent = lotteryInfo.ticket_price;
            document.getElementById('buy-price').textContent = lotteryInfo.ticket_price;
            document.getElementById('next-draw-time').textContent = lotteryInfo.next_draw_formatted;

            // Update countdown
            const timeUntil = lotteryInfo.time_until_draw;
            const countdownEl = document.getElementById('countdown-timer');
            if (timeUntil.days > 0) {
                countdownEl.textContent = `${timeUntil.days}d ${timeUntil.hours}h ${timeUntil.minutes}m`;
            } else {
                countdownEl.textContent = `${timeUntil.hours}h ${timeUntil.minutes}m`;
            }

        } catch (e) {
            console.error('Failed to load lottery info:', e);
        }
    }

    async function loadMyTickets() {
        try {
            const response = await fetch('/api/games/lottery/tickets');
            const tickets = await response.json();

            const container = document.getElementById('my-tickets');

            if (!tickets || tickets.length === 0) {
                container.innerHTML = '<div class="no-tickets">No tickets yet. Purchase one above!</div>';
                return;
            }

            container.innerHTML = tickets.map(ticket => `
                <div class="ticket-card">
                    <div class="ticket-header">
                        <span class="ticket-id">#${ticket.id}</span>
                        <span class="ticket-date">${new Date(ticket.purchased_at).toLocaleDateString()}</span>
                    </div>
                    <div class="ticket-numbers">
                        ${ticket.numbers.map(n => `<span class="ticket-num">${n}</span>`).join('')}
                    </div>
                </div>
            `).join('');

        } catch (e) {
            console.error('Failed to load tickets:', e);
        }
    }

    async function loadHistory() {
        try {
            const response = await fetch('/api/games/lottery/history');
            const history = await response.json();

            const tbody = document.getElementById('history-body');

            if (!history || history.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="no-data">No draws yet</td></tr>';
                return;
            }

            tbody.innerHTML = history.map(draw => `
                <tr>
                    <td>${draw.draw_id}</td>
                    <td class="winning-numbers">
                        ${draw.winning_numbers ? draw.winning_numbers.map(n => `<span class="win-num">${n}</span>`).join('') : 'N/A'}
                    </td>
                    <td>$${formatCurrency(draw.jackpot_amount)}</td>
                    <td>${draw.winners ? draw.winners.length : 0} winner(s)</td>
                </tr>
            `).join('');

        } catch (e) {
            console.error('Failed to load history:', e);
        }
    }

    async function checkCoinflipStatus() {
        try {
            const response = await fetch('/api/games/lottery/coinflip/status');
            const status = await response.json();

            if (status && status.id && status.status === 'pending') {
                coinflipRequestId = status.id;
                document.getElementById('coinflip-modal').style.display = 'flex';
            } else {
                document.getElementById('coinflip-modal').style.display = 'none';
            }
        } catch (e) {
            console.error('Failed to check coinflip status:', e);
        }
    }

    async function respondCoinFlip(agreed) {
        if (!coinflipRequestId) return;

        const statusEl = document.getElementById('coinflip-status');
        statusEl.textContent = 'Processing...';

        try {
            const response = await fetch('/api/games/lottery/coinflip/respond', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ request_id: coinflipRequestId, agreed: agreed })
            });

            const result = await response.json();

            if (result.success) {
                if (result.status === 'completed') {
                    showToast(result.winner_id ? 'Coin flip complete! Check your balance.' : 'Coin flip resolved!', 'success');
                    closeCoinflipModal();
                } else if (result.status === 'declined') {
                    showToast('Prize will be split 50/50', 'success');
                    closeCoinflipModal();
                } else {
                    statusEl.textContent = 'Waiting for the other player to respond...';
                }
            } else {
                statusEl.textContent = result.error || 'Error processing response';
            }
        } catch (e) {
            statusEl.textContent = 'Network error';
        }
    }

    function closeCoinflipModal() {
        document.getElementById('coinflip-modal').style.display = 'none';
    }

    function formatCurrency(amount) {
        return Number(amount).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function showToast(message, type = 'info') {
        const toast = document.getElementById('lottery-toast');
        toast.textContent = message;
        toast.className = `lottery-toast show ${type}`;
        setTimeout(() => toast.classList.remove('show'), 4000);
    }
</script>

<style>
    .lottery-container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 1.5rem;
    }

    .lottery-header {
        text-align: center;
        margin-bottom: 2rem;
    }

    .jackpot-display {
        background: linear-gradient(135deg, rgba(255, 215, 0, 0.15) 0%, rgba(255, 165, 0, 0.1) 100%);
        border: 2px solid #ffd700;
        border-radius: 20px;
        padding: 2rem;
        margin-bottom: 1.5rem;
        position: relative;
        overflow: hidden;
    }

    .jackpot-display::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255, 215, 0, 0.1) 0%, transparent 60%);
        animation: shimmer 3s infinite;
    }

    @keyframes shimmer {

        0%,
        100% {
            transform: rotate(0deg);
        }

        50% {
            transform: rotate(180deg);
        }
    }

    .jackpot-label {
        font-size: 1.2rem;
        color: #ffd700;
        margin-bottom: 0.5rem;
    }

    .jackpot-amount {
        font-size: 3.5rem;
        font-weight: bold;
        color: #ffd700;
        text-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
        font-family: 'Courier New', monospace;
        position: relative;
        z-index: 1;
    }

    .draw-countdown {
        margin-top: 1rem;
        color: #aaa;
    }

    .countdown-timer {
        font-size: 1.5rem;
        color: #00d4ff;
        margin-top: 0.5rem;
    }

    .lottery-notice {
        background: rgba(255, 152, 0, 0.2);
        border: 1px solid #ff9800;
        border-radius: 8px;
        padding: 0.75rem;
        margin-bottom: 1rem;
        color: #ff9800;
    }

    .lottery-info {
        display: flex;
        justify-content: center;
        gap: 2rem;
        flex-wrap: wrap;
    }

    .info-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: #ccc;
    }

    .info-icon {
        font-size: 1.2rem;
    }

    /* Ticket Section */
    .ticket-section,
    .prize-tiers-section,
    .my-tickets-section,
    .history-section {
        background: rgba(0, 0, 0, 0.3);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .ticket-section h3,
    .prize-tiers-section h3,
    .my-tickets-section h3,
    .history-section h3 {
        margin-bottom: 1rem;
        color: #00d4ff;
    }

    .number-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(45px, 1fr));
        gap: 8px;
        margin-bottom: 1.5rem;
        max-width: 600px;
        margin-left: auto;
        margin-right: auto;
    }

    .lottery-number {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background: #2a2a2a;
        border: 2px solid #444;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
        font-weight: bold;
        font-size: 0.9rem;
    }

    .lottery-number:hover {
        background: #3a3a3a;
        transform: scale(1.1);
        border-color: #666;
    }

    .lottery-number.selected {
        background: linear-gradient(135deg, #00d4ff, #0099cc);
        color: #000;
        border-color: #00d4ff;
        box-shadow: 0 0 15px rgba(0, 212, 255, 0.5);
        transform: scale(1.05);
    }

    .ticket-controls {
        text-align: center;
    }

    .selected-display {
        margin-bottom: 1rem;
    }

    .selected-display .label {
        color: #888;
        margin-right: 0.5rem;
    }

    .selected-numbers {
        display: inline-flex;
        gap: 0.5rem;
        min-height: 40px;
        align-items: center;
    }

    .selected-numbers .placeholder {
        color: #666;
        font-style: italic;
    }

    .selected-num {
        background: #00d4ff;
        color: #000;
        padding: 8px 12px;
        border-radius: 20px;
        font-weight: bold;
    }

    .actions {
        display: flex;
        justify-content: center;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .btn {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn.primary {
        background: linear-gradient(135deg, #00d4ff, #0099cc);
        color: #000;
    }

    .btn.primary:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(0, 212, 255, 0.4);
    }

    .btn.primary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .btn.secondary {
        background: #333;
        color: #fff;
        border: 1px solid #555;
    }

    .btn.secondary:hover {
        background: #444;
    }

    /* Prize Tiers */
    .tiers-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
    }

    .tier {
        background: #2a2a2a;
        border-radius: 10px;
        padding: 1rem;
        text-align: center;
        border: 1px solid #444;
    }

    .tier.jackpot-tier {
        background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 165, 0, 0.1));
        border-color: #ffd700;
    }

    .tier-match {
        font-size: 0.9rem;
        color: #888;
        margin-bottom: 0.5rem;
    }

    .tier-prize {
        font-size: 1.2rem;
        font-weight: bold;
        color: #fff;
    }

    .jackpot-tier .tier-prize {
        color: #ffd700;
    }

    /* My Tickets */
    .tickets-container {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .no-tickets,
    .no-data {
        color: #666;
        text-align: center;
        padding: 2rem;
        width: 100%;
    }

    .ticket-card {
        background: #1a1a1a;
        border: 1px dashed #444;
        border-radius: 10px;
        padding: 1rem;
        min-width: 200px;
    }

    .ticket-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.75rem;
        color: #888;
        font-size: 0.85rem;
    }

    /* Premium Styles */
    .lottery-hero {
        display: grid;
        grid-template-columns: 1.5fr 1fr;
        gap: 20px;
        margin-bottom: 30px;
    }

    .jackpot-card {
        background: radial-gradient(circle at top right, rgba(255, 215, 0, 0.15), rgba(0, 0, 0, 0.4));
        border: 1px solid #ffd700;
        border-radius: 20px;
        padding: 30px;
        position: relative;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        justify-content: center;
        box-shadow: 0 0 30px rgba(255, 215, 0, 0.1);
    }

    .jackpot-card::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(90deg, transparent, #ffd700, transparent);
        opacity: 0.5;
    }

    .jackpot-label {
        font-family: 'Inter', sans-serif;
        font-size: 0.9rem;
        letter-spacing: 2px;
        color: #ffd700;
        margin-bottom: 10px;
        text-transform: uppercase;
        opacity: 0.8;
    }

    .jackpot-value {
        font-family: 'JetBrains Mono', monospace;
        font-size: 3.5rem;
        font-weight: 800;
        color: #fff;
        text-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        margin-bottom: 20px;
    }

    .draw-info {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .countdown-pill {
        background: rgba(255, 215, 0, 0.1);
        border: 1px solid rgba(255, 215, 0, 0.3);
        padding: 5px 15px;
        border-radius: 20px;
        display: flex;
        align-items: center;
        gap: 8px;
        color: #ffd700;
        font-family: 'JetBrains Mono', monospace;
        font-size: 0.9rem;
    }

    .next-draw-date {
        color: var(--text-dim);
        font-size: 0.8rem;
    }

    .lottery-stats {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .stat-item {
        background: var(--bg-panel);
        border: 1px solid var(--glass-border);
        padding: 15px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        gap: 15px;
        transition: all 0.3s;
    }

    .stat-item:hover {
        border-color: var(--primary);
        transform: translateX(5px);
    }

    .stat-icon {
        font-size: 1.5rem;
        background: rgba(255, 255, 255, 0.05);
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
    }

    .stat-text {
        display: flex;
        flex-direction: column;
    }

    .stat-text .label {
        font-size: 0.7rem;
        color: var(--text-dim);
        text-transform: uppercase;
    }

    .stat-text .value {
        font-size: 1.1rem;
        color: var(--text-main);
        font-weight: 600;
    }

    /* Ticket Panel */
    .glass-panel {
        background: var(--glass);
        border: 1px solid var(--glass-border);
        border-radius: 16px;
        overflow: hidden;
        margin-bottom: 30px;
    }

    .panel-header {
        background: rgba(255, 255, 255, 0.02);
        padding: 15px 20px;
        border-bottom: 1px solid var(--glass-border);
    }

    .panel-header h3 {
        margin: 0;
        font-size: 1.1rem;
        color: var(--primary);
    }

    .selection-area {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 0;
    }

    .number-grid-wrapper {
        padding: 30px;
        border-right: 1px solid var(--glass-border);
    }

    .number-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 10px;
        max-width: 500px;
        margin: 0 auto;
    }

    .lottery-number {
        aspect-ratio: 1;
        background: var(--bg-dark);
        border: 1px solid var(--glass-border);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
        font-family: 'JetBrains Mono', monospace;
        color: var(--text-dim);
        font-size: 0.9rem;
    }

    .lottery-number:hover {
        border-color: var(--primary);
        color: var(--text-main);
        background: rgba(0, 242, 234, 0.1);
    }

    .lottery-number.selected {
        background: var(--primary);
        color: #000;
        border-color: var(--primary);
        box-shadow: 0 0 15px rgba(0, 242, 234, 0.4);
        transform: scale(1.1);
        font-weight: bold;
    }

    .ticket-sidebar {
        padding: 30px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        background: rgba(0, 0, 0, 0.2);
    }

    .selected-numbers-card {
        background: var(--bg-dark);
        border: 1px solid var(--glass-border);
        border-radius: 12px;
        padding: 20px;
    }

    .selected-numbers-card label {
        display: block;
        font-size: 0.7rem;
        color: var(--text-dim);
        margin-bottom: 10px;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .selected-numbers {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        min-height: 40px;
    }

    .selected-num {
        background: rgba(0, 242, 234, 0.1);
        border: 1px solid var(--primary);
        color: var(--primary);
        padding: 5px 10px;
        border-radius: 15px;
        font-family: 'JetBrains Mono', monospace;
        font-size: 0.9rem;
    }

    .ticket-actions {
        margin-top: 20px;
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .action-row {
        display: flex;
        gap: 10px;
    }

    .action-btn.small {
        padding: 8px;
        font-size: 0.8rem;
    }

    .buy-btn {
        width: 100%;
        display: flex;
        justify-content: space-between;
        padding: 15px 20px;
    }

    .buy-btn .price-tag {
        background: rgba(0, 0, 0, 0.2);
        padding: 2px 8px;
        border-radius: 4px;
        font-family: 'JetBrains Mono', monospace;
    }

    /* Prize Tiers & History Tables */
    .history-table {
        width: 100%;
        border-collapse: collapse;
    }

    .history-table th {
        text-align: left;
        padding: 15px;
        color: var(--text-dim);
        font-size: 0.8rem;
        text-transform: uppercase;
        border-bottom: 1px solid var(--glass-border);
    }

    .history-table td {
        padding: 15px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        color: var(--text-main);
    }

    .win-num {
        background: rgba(255, 255, 255, 0.1);
        padding: 2px 6px;
        border-radius: 4px;
        margin-right: 4px;
        font-size: 0.85rem;
        font-family: 'JetBrains Mono', monospace;
    }

    /* Balance Pill (Copied) */
    .balance-pill {
        background: var(--glass);
        border: 1px solid var(--glass-border);
        padding: 0.5rem 1rem;
        border-radius: 20px;
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        min-width: 100px;
    }

    .balance-pill .label {
        font-size: 0.65rem;
        color: var(--text-dim);
        font-weight: 700;
        letter-spacing: 1px;
    }

    .balance-pill .value {
        font-size: 1.1rem;
        color: var(--primary);
        font-family: 'JetBrains Mono', monospace;
        font-weight: 700;
        line-height: 1;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .lottery-hero {
            grid-template-columns: 1fr;
        }

        .selection-area {
            grid-template-columns: 1fr;
        }

        .number-grid-wrapper {
            border-right: none;
            border-bottom: 1px solid var(--glass-border);
        }

        .number-grid {
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }
    }

    .ticket-num {
        background: #333;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.9rem;
    }

    /* History */
    .history-container {
        overflow-x: auto;
    }

    .history-table {
        width: 100%;
        border-collapse: collapse;
    }

    .history-table th,
    .history-table td {
        padding: 0.75rem;
        text-align: left;
        border-bottom: 1px solid #333;
    }

    .history-table th {
        background: #1a1a1a;
        color: #888;
    }

    .winning-numbers {
        display: flex;
        gap: 0.3rem;
    }

    .win-num {
        background: #ffd700;
        color: #000;
        padding: 2px 6px;
        border-radius: 4px;
        font-weight: bold;
        font-size: 0.85rem;
    }

    /* Modal */
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .modal-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
    }

    .modal-content {
        background: #1a1a1a;
        border: 2px solid #ffd700;
        border-radius: 16px;
        padding: 2rem;
        max-width: 500px;
        position: relative;
        z-index: 1;
        text-align: center;
    }

    .modal-content h2 {
        color: #ffd700;
        margin-bottom: 1rem;
    }

    .modal-content ul {
        text-align: left;
        margin: 1rem 0;
        padding-left: 1.5rem;
    }

    .modal-content .warning {
        color: #ff9800;
        margin: 1rem 0;
    }

    .modal-actions {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-top: 1.5rem;
    }

    .modal-status {
        margin-top: 1rem;
        color: #888;
    }

    /* Toast */
    .lottery-toast {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%) translateY(100px);
        background: #333;
        color: #fff;
        padding: 1rem 2rem;
        border-radius: 8px;
        opacity: 0;
        transition: all 0.3s;
        z-index: 1001;
    }

    .lottery-toast.show {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
    }

    .lottery-toast.success {
        background: linear-gradient(135deg, #4caf50, #2e7d32);
    }

    .lottery-toast.error {
        background: linear-gradient(135deg, #f44336, #c62828);
    }

    @media (max-width: 600px) {
        .jackpot-amount {
            font-size: 2.5rem;
        }

        .lottery-info {
            flex-direction: column;
            gap: 0.5rem;
        }

        .number-grid {
            grid-template-columns: repeat(7, 1fr);
        }

        .lottery-number {
            width: 38px;
            height: 38px;
            font-size: 0.8rem;
        }
    }
</style>
{% endblock %}